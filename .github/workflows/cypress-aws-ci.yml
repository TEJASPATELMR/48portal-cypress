name: CI - Cypress -> AWS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  id-token: write   # required for OIDC

env:
  AWS_REGION: ap-south-1
  S3_BUCKET: tejas-48portal-artifacts
  SNS_TOPIC_ARN: arn:aws:sns:ap-south-1:976522647233:cypress-build-notifications

jobs:
  run-cypress:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Configure AWS credentials (OIDC assume role)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Run Cypress tests (headless)
        # Do NOT swallow errors here so the job fails on test failure.
        run: npx cypress run --browser chrome --headless

      - name: Upload Cypress videos and screenshots to S3
        if: always()
        run: |
          echo "Uploading screenshots and videos to S3..."
          aws s3 cp cypress/videos/ s3://${S3_BUCKET}/videos/ --recursive || echo "no videos found or upload failed"
          aws s3 cp cypress/screenshots/ s3://${S3_BUCKET}/screenshots/ --recursive || echo "no screenshots found or upload failed"

      - name: Publish success notification to SNS
        if: success()
        run: |
          aws sns publish \
            --region ${AWS_REGION} \
            --topic-arn "${SNS_TOPIC_ARN}" \
            --subject "✅ Cypress build succeeded: ${{ github.repository }}" \
            --message "Branch: ${{ github.ref }}\nCommit: ${{ github.sha }}\nRun: ${{ github.run_url }}"

      - name: Publish failure notification to SNS
        if: failure()
        run: |
          aws sns publish \
            --region ${AWS_REGION} \
            --topic-arn "${SNS_TOPIC_ARN}" \
            --subject "❌ Cypress build FAILED: ${{ github.repository }}" \
            --message "Branch: ${{ github.ref }}\nCommit: ${{ github.sha }}\nRun: ${{ github.run_url }}"
